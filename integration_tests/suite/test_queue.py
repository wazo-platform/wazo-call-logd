# Copyright 2025 The Wazo Authors  (see the AUTHORS file)
# SPDX-License-Identifier: GPL-3.0-or-later

from hamcrest import has_properties

from .helpers.base import RawCelIntegrationTest, raw_cels


class TestCallToQueue(RawCelIntegrationTest):
    @raw_cels(
        """
                    eventtype             |           eventtime           |           userdeftype            | cid_name | cid_num | cid_ani |   cid_dnid   |    exten     |                           context                            |              channame               |     appname     |                                                                                      appdata                                                                                       |   uniqueid    |   linkedid    |          peer           |                                                                             extra
        ----------------------------------+-------------------------------+----------------------------------+----------+---------+---------+--------------+--------------+--------------------------------------------------------------+-------------------------------------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+---------------+-------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------
        CHAN_START                       | 2025-09-08 15:33:24.567796-04 |                                  | Fern     | 10006   |         |              | *94186560000 | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/yeFKZg6L-00000013             |                 |                                                                                                                                                                                    | 1757360004.25 | 1757360004.25 |                         |
        XIVO_INCALL                      | 2025-09-08 15:33:24.907327-04 | XIVO_INCALL                      | Fern     | 10006   | 10006   | *94186560000 | s            | did                                                          | PJSIP/yeFKZg6L-00000013             | CELGenUserEvent | XIVO_INCALL,82f60c78-fc94-4936-b3fb-7b276c69df9d                                                                                                                                   | 1757360004.25 | 1757360004.25 |                         | {"extra":"82f60c78-fc94-4936-b3fb-7b276c69df9d"}
        WAZO_CALL_LOG_REQUESTED_INTERNAL | 2025-09-08 15:33:25.106326-04 | WAZO_CALL_LOG_REQUESTED_INTERNAL | Fern     | 10006   | 10006   | *94186560000 | s            | queue                                                        | PJSIP/yeFKZg6L-00000013             | CELGenUserEvent | WAZO_CALL_LOG_REQUESTED_INTERNAL,type: queue,number: 30001,context: ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05,tenant_uuid: 82f60c78-fc94-4936-b3fb-7b276c69df9d | 1757360004.25 | 1757360004.25 |                         | {"extra":"type: queue,number: 30001,context: ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05,tenant_uuid: 82f60c78-fc94-4936-b3fb-7b276c69df9d"}
        ANSWER                           | 2025-09-08 15:33:25.286664-04 |                                  | Fern     | 10006   | 10006   | *94186560000 | pickup       | xivo-pickup                                                  | PJSIP/yeFKZg6L-00000013             | Answer          |                                                                                                                                                                                    | 1757360004.25 | 1757360004.25 |                         |
        APP_START                        | 2025-09-08 15:33:26.485068-04 |                                  | Fern     | 10006   | 10006   | *94186560000 | s            | queue                                                        | PJSIP/yeFKZg6L-00000013             | Queue           | q-11668931,iC,,,,,wazo-queue-answered,,,                                                                                                                                           | 1757360004.25 | 1757360004.25 |                         |
        CHAN_START                       | 2025-09-08 15:33:26.53585-04  |                                  |          |         |         |              | id-9         | agentcallback                                                | Local/id-9@agentcallback-00000003;1 |                 |                                                                                                                                                                                    | 1757360006.26 | 1757360004.25 |                         |
        CHAN_START                       | 2025-09-08 15:33:26.536058-04 |                                  |          |         |         |              | id-9         | agentcallback                                                | Local/id-9@agentcallback-00000003;2 |                 |                                                                                                                                                                                    | 1757360006.27 | 1757360004.25 |                         |
        APP_START                        | 2025-09-08 15:33:26.749372-04 |                                  | Fern     | 10006   | 10006   |              | id-9         | agentcallback                                                | Local/id-9@agentcallback-00000003;2 | Dial            | PJSIP/qhFVHMgy,,i                                                                                                                                                                  | 1757360006.27 | 1757360004.25 |                         |
        CHAN_START                       | 2025-09-08 15:33:26.75248-04  |                                  | Julien   | 10009   |         |              | s            | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/qhFVHMgy-00000014             |                 |                                                                                                                                                                                    | 1757360006.28 | 1757360004.25 |                         |
        ANSWER                           | 2025-09-08 15:33:28.995873-04 |                                  | Julien   | 10009   | 10009   |              | id-9         | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/qhFVHMgy-00000014             | AppDial         | (Outgoing Line)                                                                                                                                                                    | 1757360006.28 | 1757360004.25 |                         |
        ANSWER                           | 2025-09-08 15:33:28.99653-04  |                                  | Fern     | 10006   | 10006   |              | id-9         | agentcallback                                                | Local/id-9@agentcallback-00000003;2 | Dial            | PJSIP/qhFVHMgy,,i                                                                                                                                                                  | 1757360006.27 | 1757360004.25 |                         |
        ANSWER                           | 2025-09-08 15:33:28.997303-04 |                                  | Julien   | 10009   |         |              | s            | agentcallback                                                | Local/id-9@agentcallback-00000003;1 | AppQueue        | (Outgoing Line)                                                                                                                                                                    | 1757360006.26 | 1757360004.25 |                         |
        BRIDGE_ENTER                     | 2025-09-08 15:33:29.075085-04 |                                  | Julien   | 10009   | 10009   |              |              | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/qhFVHMgy-00000014             | AppDial         | (Outgoing Line)                                                                                                                                                                    | 1757360006.28 | 1757360004.25 |                         | {"bridge_id":"1476cec3-72a1-408c-8379-fbd4eb269f6f","bridge_technology":"simple_bridge"}
        BRIDGE_ENTER                     | 2025-09-08 15:33:29.075657-04 |                                  | Fern     | 10006   | 10006   |              | id-9         | agentcallback                                                | Local/id-9@agentcallback-00000003;2 | Dial            | PJSIP/qhFVHMgy,,i                                                                                                                                                                  | 1757360006.27 | 1757360004.25 | PJSIP/qhFVHMgy-00000014 | {"bridge_id":"1476cec3-72a1-408c-8379-fbd4eb269f6f","bridge_technology":"simple_bridge"}
        BRIDGE_ENTER                     | 2025-09-08 15:33:29.292721-04 |                                  | Julien   | 10009   |         |              | s            | agentcallback                                                | Local/id-9@agentcallback-00000003;1 | AppQueue        | (Outgoing Line)                                                                                                                                                                    | 1757360006.26 | 1757360004.25 |                         | {"bridge_id":"38a6fd07-dacc-476f-a980-e7d24b43bf79","bridge_technology":"simple_bridge"}
        BRIDGE_ENTER                     | 2025-09-08 15:33:29.293791-04 |                                  | Fern     | 10006   | 10006   | *94186560000 | s            | queue                                                        | PJSIP/yeFKZg6L-00000013             | Queue           | q-11668931,iC,,,,,wazo-queue-answered,,,                                                                                                                                           | 1757360004.25 | 1757360004.25 |                         | {"bridge_id":"38a6fd07-dacc-476f-a980-e7d24b43bf79","bridge_technology":"simple_bridge"}
        BRIDGE_EXIT                      | 2025-09-08 15:33:29.300964-04 |                                  | Julien   | 10009   | 10009   |              |              | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/qhFVHMgy-00000014             | AppDial         | (Outgoing Line)                                                                                                                                                                    | 1757360006.28 | 1757360004.25 |                         | {"bridge_id":"1476cec3-72a1-408c-8379-fbd4eb269f6f","bridge_technology":"simple_bridge"}
        BRIDGE_EXIT                      | 2025-09-08 15:33:29.301231-04 |                                  | Julien   | 10009   |         |              | s            | agentcallback                                                | Local/id-9@agentcallback-00000003;1 | AppQueue        | (Outgoing Line)                                                                                                                                                                    | 1757360006.26 | 1757360004.25 | PJSIP/yeFKZg6L-00000013 | {"bridge_id":"38a6fd07-dacc-476f-a980-e7d24b43bf79","bridge_technology":"simple_bridge"}
        BRIDGE_ENTER                     | 2025-09-08 15:33:29.30125-04  |                                  | Julien   | 10009   | 10009   |              |              | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/qhFVHMgy-00000014             | AppDial         | (Outgoing Line)                                                                                                                                                                    | 1757360006.28 | 1757360004.25 | PJSIP/yeFKZg6L-00000013 | {"bridge_id":"38a6fd07-dacc-476f-a980-e7d24b43bf79","bridge_technology":"simple_bridge"}
        HANGUP                           | 2025-09-08 15:33:29.301865-04 |                                  | Julien   | 10009   |         |              | s            | agentcallback                                                | Local/id-9@agentcallback-00000003;1 | AppQueue        | (Outgoing Line)                                                                                                                                                                    | 1757360006.26 | 1757360004.25 |                         | {"hangupcause":26,"hangupsource":"","dialstatus":""}
        CHAN_END                         | 2025-09-08 15:33:29.301865-04 |                                  | Julien   | 10009   |         |              | s            | agentcallback                                                | Local/id-9@agentcallback-00000003;1 | AppQueue        | (Outgoing Line)                                                                                                                                                                    | 1757360006.26 | 1757360004.25 |                         |
        BRIDGE_EXIT                      | 2025-09-08 15:33:29.303311-04 |                                  | Fern     | 10006   | 10006   |              | id-9         | agentcallback                                                | Local/id-9@agentcallback-00000003;2 | Dial            | PJSIP/qhFVHMgy,,i                                                                                                                                                                  | 1757360006.27 | 1757360004.25 |                         | {"bridge_id":"1476cec3-72a1-408c-8379-fbd4eb269f6f","bridge_technology":"simple_bridge"}
        HANGUP                           | 2025-09-08 15:33:29.303706-04 |                                  | Fern     | 10006   | 10006   |              | id-9         | agentcallback                                                | Local/id-9@agentcallback-00000003;2 |                 |                                                                                                                                                                                    | 1757360006.27 | 1757360004.25 |                         | {"hangupcause":26,"hangupsource":"","dialstatus":"ANSWER"}
        CHAN_END                         | 2025-09-08 15:33:29.303706-04 |                                  | Fern     | 10006   | 10006   |              | id-9         | agentcallback                                                | Local/id-9@agentcallback-00000003;2 |                 |                                                                                                                                                                                    | 1757360006.27 | 1757360004.25 |                         |
        BRIDGE_EXIT                      | 2025-09-08 15:33:30.808965-04 |                                  | Julien   | 10009   | 10009   |              |              | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/qhFVHMgy-00000014             | AppDial         | (Outgoing Line)                                                                                                                                                                    | 1757360006.28 | 1757360004.25 | PJSIP/yeFKZg6L-00000013 | {"bridge_id":"38a6fd07-dacc-476f-a980-e7d24b43bf79","bridge_technology":"simple_bridge"}
        BRIDGE_EXIT                      | 2025-09-08 15:33:30.810343-04 |                                  | Fern     | 10006   | 10006   | *94186560000 | s            | queue                                                        | PJSIP/yeFKZg6L-00000013             | Queue           | q-11668931,iC,,,,,wazo-queue-answered,,,                                                                                                                                           | 1757360004.25 | 1757360004.25 |                         | {"bridge_id":"38a6fd07-dacc-476f-a980-e7d24b43bf79","bridge_technology":"simple_bridge"}
        HANGUP                           | 2025-09-08 15:33:30.813111-04 |                                  | Julien   | 10009   | 10009   |              |              | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/qhFVHMgy-00000014             | AppDial         | (Outgoing Line)                                                                                                                                                                    | 1757360006.28 | 1757360004.25 |                         | {"hangupcause":16,"hangupsource":"PJSIP/qhFVHMgy-00000014","dialstatus":""}
        CHAN_END                         | 2025-09-08 15:33:30.813111-04 |                                  | Julien   | 10009   | 10009   |              |              | ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05 | PJSIP/qhFVHMgy-00000014             | AppDial         | (Outgoing Line)                                                                                                                                                                    | 1757360006.28 | 1757360004.25 |                         |
        HANGUP                           | 2025-09-08 15:33:30.81377-04  |                                  | Fern     | 10006   | 10006   | *94186560000 | s            | queue                                                        | PJSIP/yeFKZg6L-00000013             |                 |                                                                                                                                                                                    | 1757360004.25 | 1757360004.25 |                         | {"hangupcause":16,"hangupsource":"PJSIP/qhFVHMgy-00000014","dialstatus":"ANSWER"}
        CHAN_END                         | 2025-09-08 15:33:30.81377-04  |                                  | Fern     | 10006   | 10006   | *94186560000 | s            | queue                                                        | PJSIP/yeFKZg6L-00000013             |                 |                                                                                                                                                                                    | 1757360004.25 | 1757360004.25 |                         |
        LINKEDID_END                     | 2025-09-08 15:33:30.81377-04  |                                  | Fern     | 10006   | 10006   | *94186560000 | s            | queue                                                        | PJSIP/yeFKZg6L-00000013             |                 |                                                                                                                                                                                    | 1757360004.25 | 1757360004.25 |                         |
       """
    )
    def test_call_to_queue_requested_internal_exten_is_not_the_destination_exten(self):
        self._assert_last_call_log_matches(
            '1757360004.25',
            has_properties(
                requested_internal_exten='30001',
                requested_internal_context='ctx-pcmdev00de-internal-a25ef16e-faaf-41ad-b1ad-aa2d715b6c05',
            ),
        )
